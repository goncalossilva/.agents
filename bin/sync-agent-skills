#!/usr/bin/env bash
set -euo pipefail

# Symlink ~/.agents/skills and ~/.agents/AGENTS.md into Codex + Claude.
#
# ~/.agents is the source of truth; targets are replaced with symlinks when needed.

AGENTS_SKILLS_DIR="${HOME}/.agents/skills"
AGENTS_INSTRUCTIONS_FILE="${HOME}/.agents/AGENTS.md"
CODEX_SKILLS_DIR="${HOME}/.codex/skills"
CLAUDE_SKILLS_DIR="${HOME}/.claude/skills"
CODEX_INSTRUCTIONS_FILE="${HOME}/.codex/AGENTS.md"
CLAUDE_INSTRUCTIONS_FILE="${HOME}/.claude/CLAUDE.md"

DRY_RUN=0
YES=0
PRUNE=0

usage() {
  cat <<'EOF'
	Symlink ~/.agents/skills and ~/.agents/AGENTS.md into Codex + Claude.

Usage:
  sync-agent-skills [--dry-run] [--yes] [--prune]

Options:
  --dry-run   Print planned changes only
  --yes       Apply without prompting
  --prune     Remove skills from agent folders that are not present in ~/.agents/skills

Notes:
  - ~/.codex/skills/.system is never touched.
  - ~/.agents/AGENTS.md is symlinked to ~/.codex/AGENTS.md and ~/.claude/CLAUDE.md.
EOF
}

while [[ $# -gt 0 ]]; do
  case "$1" in
    --dry-run)
      DRY_RUN=1
      shift
      ;;
    --yes)
      YES=1
      shift
      ;;
    --prune)
      PRUNE=1
      shift
      ;;
    -h | --help)
      usage
      exit 0
      ;;
    *)
      echo "error: unknown argument: $1" >&2
      usage >&2
      exit 2
      ;;
  esac
done

mkdir -p "${AGENTS_SKILLS_DIR}" "${CODEX_SKILLS_DIR}" "${CLAUDE_SKILLS_DIR}"

skills=()
for skill_dir in "${AGENTS_SKILLS_DIR}"/*; do
  [[ -d "${skill_dir}" ]] || continue
  skill_name="$(basename "${skill_dir}")"
  [[ "${skill_name}" == .* ]] && continue
  skills+=("${skill_name}")
done

declare -a plan=()

plan_symlink() {
  local src="$1"
  local dest="$2"
  plan+=("symlink:${src}:${dest}")
}

plan_remove() {
  local path="$1"
  case "${path}" in
    "${CODEX_SKILLS_DIR}"/* | "${CLAUDE_SKILLS_DIR}"/* | "${CODEX_INSTRUCTIONS_FILE}" | "${CLAUDE_INSTRUCTIONS_FILE}")
      plan+=("rmrf:${path}")
      ;;
    *)
      echo "error: refusing to remove unexpected path: ${path}" >&2
      exit 1
      ;;
  esac
}

for skill_name in "${skills[@]}"; do
  skill_dir="${AGENTS_SKILLS_DIR}/${skill_name}"
  for target_root in "${CODEX_SKILLS_DIR}" "${CLAUDE_SKILLS_DIR}"; do
    target="${target_root}/${skill_name}"

    if [[ -L "${target}" ]]; then
      existing_target="$(readlink "${target}")"
      if [[ "${existing_target}" == "${skill_dir}" ]]; then
        continue
      fi
      plan_remove "${target}"
      plan_symlink "${skill_dir}" "${target}"
      continue
    fi

    if [[ -d "${target}" ]]; then
      plan_remove "${target}"
      plan_symlink "${skill_dir}" "${target}"
      continue
    fi

    if [[ -e "${target}" ]]; then
      echo "skip: ${target} exists and is not a directory/symlink" >&2
      continue
    fi

    plan_symlink "${skill_dir}" "${target}"
  done
done

if [[ -f "${AGENTS_INSTRUCTIONS_FILE}" ]]; then
  for target in "${CODEX_INSTRUCTIONS_FILE}" "${CLAUDE_INSTRUCTIONS_FILE}"; do
    if [[ -L "${target}" ]]; then
      existing_target="$(readlink "${target}")"
      if [[ "${existing_target}" == "${AGENTS_INSTRUCTIONS_FILE}" ]]; then
        continue
      fi
      plan_remove "${target}"
      plan_symlink "${AGENTS_INSTRUCTIONS_FILE}" "${target}"
      continue
    fi

    if [[ -f "${target}" ]]; then
      plan_remove "${target}"
      plan_symlink "${AGENTS_INSTRUCTIONS_FILE}" "${target}"
      continue
    fi

    if [[ -e "${target}" ]]; then
      echo "skip: ${target} exists and is not a file/symlink" >&2
      continue
    fi

    plan_symlink "${AGENTS_INSTRUCTIONS_FILE}" "${target}"
  done
else
  echo "warn: ${AGENTS_INSTRUCTIONS_FILE} not found; skipping instruction sync" >&2
fi

if [[ "${PRUNE}" -eq 1 ]]; then
  for target_root in "${CODEX_SKILLS_DIR}" "${CLAUDE_SKILLS_DIR}"; do
    for entry in "${target_root}"/*; do
      [[ -e "${entry}" ]] || continue
      base="$(basename "${entry}")"
      [[ "${base}" == ".system" ]] && continue

      keep=0
      for skill_name in "${skills[@]}"; do
        if [[ "${base}" == "${skill_name}" ]]; then
          keep=1
          break
        fi
      done

      if [[ "${keep}" -eq 0 ]]; then
        plan_remove "${entry}"
      fi
    done
  done
fi

echo "Planned changes:"
if [[ ${#plan[@]} -eq 0 ]]; then
  echo "  (no changes needed)"
  exit 0
fi

for op in "${plan[@]}"; do
  kind="${op%%:*}"
  rest="${op#*:}"
  case "${kind}" in
    symlink)
      src="${rest%%:*}"
      dest="${rest#*:}"
      echo "  - symlink: ${dest} -> ${src}"
      ;;
    rmrf)
      echo "  - remove: ${rest}"
      ;;
  esac
done

if [[ "${DRY_RUN}" -eq 1 ]]; then
  exit 0
fi

if [[ "${YES}" -ne 1 ]]; then
  if [[ ! -t 0 ]]; then
    echo "error: refusing to apply changes non-interactively without --yes" >&2
    exit 2
  fi

  read -r -p "Apply these changes? [y/N] " answer
  case "${answer}" in
    y | Y | yes | YES) ;;
    *) echo "aborted"; exit 0 ;;
  esac
fi

applied=0
for op in "${plan[@]}"; do
  kind="${op%%:*}"
  rest="${op#*:}"
  case "${kind}" in
    rmrf)
      rm -rf "${rest}"
      ;;
    symlink)
      src="${rest%%:*}"
      dest="${rest#*:}"
      mkdir -p "$(dirname "${dest}")"
      ln -sfn "${src}" "${dest}"
      ;;
  esac
  applied=$((applied + 1))
done

echo "applied ${applied} operations"
